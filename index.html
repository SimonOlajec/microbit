<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>micro:bit — Web Bluetooth UART</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:18px}
    button{margin:.25rem}
    #log{width:100%;height:260px;border:1px solid #ccc;padding:8px;overflow:auto;background:#f9f9f9}
    .row{display:flex;gap:.5rem;align-items:center;margin:.5rem 0}
    input[type=text]{flex:1;padding:.4rem}
    label{font-size:.9rem}
    .small{font-size:.85rem;color:#555}
  </style>
</head>
<body>
  <h1>micro:bit — Web Bluetooth (UART)</h1>
  <p class="small">Táto stránka používa Web Bluetooth API na pripojenie k micro:bitu cez UART (Nordic UART Service). Musíte stránku otvoriť cez <strong>https</strong> alebo z <strong>localhost</strong>.</p>

  <div class="row">
    <button id="connectBtn">Pripojiť k micro:bit</button>
    <button id="disconnectBtn" disabled>Odpojiť</button>
    <span id="status" class="small">Nepripojené</span>
  </div>

  <div class="row">
    <input id="sendInput" type="text" placeholder="Zadaj text na odoslanie (napr. 'hello')">
    <button id="sendBtn" disabled>Odoslať</button>
  </div>

  <div class="row">
    <label><input type="checkbox" id="hexToggle"> Zobraziť v hex</label>
  </div>

  <div id="log" aria-live="polite"></div>

  <script>
    // UART (Nordic) UUIDs - micro:bit exposes a UART-compatible service in many firmwares.
    const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const UART_RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write -> micro:bit (RX)
    const UART_TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify <- micro:bit (TX)

    let device = null;
    let server = null;
    let rxChar = null; // write
    let txChar = null; // notify

    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const sendInput = document.getElementById('sendInput');
    const hexToggle = document.getElementById('hexToggle');

    function appendLog(text){
      const time = new Date().toLocaleTimeString();
      logEl.innerText += `[${time}] ${text}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function connectMicrobit(){
      try{
        appendLog('Požiadajte výber zariadenia...');
        device = await navigator.bluetooth.requestDevice({
          filters: [{namePrefix: 'BBC micro:bit'}],
          optionalServices: [UART_SERVICE_UUID]
        });
        device.addEventListener('gattserverdisconnected', onDisconnected);

        appendLog('Pripájanie k GATT serveru...');
        server = await device.gatt.connect();

        appendLog('Získavam UART service...');
        const service = await server.getPrimaryService(UART_SERVICE_UUID);

        appendLog('Získavam RX (write) characteristic...');
        rxChar = await service.getCharacteristic(UART_RX_CHAR_UUID);

        appendLog('Získavam TX (notify) characteristic a registrujem notifikácie...');
        txChar = await service.getCharacteristic(UART_TX_CHAR_UUID);
        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', handleNotifications);

        statusEl.innerText = `Pripojené: ${device.name || device.id}`;
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        sendBtn.disabled = false;
        appendLog('Pripojené. Môžete odosielať text cez políčko a kliknúť Odoslať.');

      }catch(err){
        console.error(err);
        appendLog('Chyba pri pripojení: ' + err);
      }
    }

    function onDisconnected(){
      appendLog('Zariadenie bolo odpojené.');
      statusEl.innerText = 'Nepripojené';
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      sendBtn.disabled = true;
    }

    function handleNotifications(event){
      const value = event.target.value; // DataView
      const bytes = new Uint8Array(value.buffer);
      if(hexToggle.checked){
        const hex = Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join(' ');
        appendLog('Prijaté (HEX): ' + hex);
      } else {
        // try decode as UTF-8 text
        try{
          const text = new TextDecoder().decode(bytes);
          appendLog('Prijaté (text): ' + text);
        }catch(e){
          appendLog('Prijaté (raw bytes): ' + bytes.join(','));
        }
      }
    }

    async function sendToMicrobit(){
      const text = sendInput.value || '';
      if(!rxChar){ appendLog('Nie je charakteristika na zápis.'); return; }
      try{
        // encode as UTF-8 and write (split to 20-byte chunks if necessary)
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const MTU = 20;
        for(let i=0;i<data.length;i+=MTU){
          const chunk = data.slice(i, i+MTU);
          await rxChar.writeValue(chunk);
        }
        appendLog('Odoslané: ' + text);
      }catch(err){
        appendLog('Chyba pri odoslaní: ' + err);
      }
    }

    async function disconnectMicrobit(){
      try{
        if(device && device.gatt.connected){
          await device.gatt.disconnect();
        }
        onDisconnected();
      }catch(err){
        appendLog('Chyba pri odpojení: ' + err);
      }
    }

    connectBtn.addEventListener('click', ()=>{
      if(!('bluetooth' in navigator)){
        appendLog('Toto zariadenie/prehliadač nepodporuje Web Bluetooth. Použite Chrome/Edge na počítači alebo Android.');
        return;
      }
      connectMicrobit();
    });

    disconnectBtn.addEventListener('click', disconnectMicrobit);
    sendBtn.addEventListener('click', sendToMicrobit);

    // quick convenience: press Enter to send
    sendInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendToMicrobit(); } });

    // Helpful note: modern micro:bit MakeCode / Python: use "start uart service" block or corresponding library to enable UART.
  </script>
</body>
</html>
>